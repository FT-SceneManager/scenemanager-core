name: Smart Release v3.2 FINAL

permissions:
  contents: write

on:
  push:
    branches: [ master ]

  workflow_dispatch:
    inputs:
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options: [ upgrade, update, patch ]

jobs:
  smart-release:
    runs-on: ubuntu-latest

    env:
      UPLOAD_ATTEMPTED: false
      RELEASE_UPLOADED: false

    steps:
      # --------------------------------------------------
      # Checkout
      # --------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # --------------------------------------------------
      # Java
      # --------------------------------------------------
      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 25

      # --------------------------------------------------
      # Read current version
      # --------------------------------------------------
      - name: Read version
        id: version
        run: |
          RAW=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          BASE="${RAW%-SNAPSHOT}"
          echo "base=$BASE" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Determine bump type
      # --------------------------------------------------
      - name: Determine bump type
        id: bump
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=${{ inputs.bump_type }}" >> $GITHUB_OUTPUT
            exit 0
          fi

          MSG="${{ github.event.head_commit.message }}"

          [[ "$MSG" == *"-upgrade"* ]] && echo "type=upgrade" >> $GITHUB_OUTPUT && exit 0
          [[ "$MSG" == *"-update"*  ]] && echo "type=update"  >> $GITHUB_OUTPUT && exit 0
          [[ "$MSG" == *"-patch"*   ]] && echo "type=patch"   >> $GITHUB_OUTPUT && exit 0

          echo "type=none" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Version bump
      # --------------------------------------------------
      - name: Bump version
        if: steps.bump.outputs.type != 'none'
        id: bumpver
        run: |
          IFS='.' read -r X Y Z <<< "${{ steps.version.outputs.base }}"

          case "${{ steps.bump.outputs.type }}" in
            upgrade) X=$((X+1)); Y=0; Z=0 ;;
            update)  Y=$((Y+1)); Z=0 ;;
            patch)   Z=$((Z+1)) ;;
          esac

          NEW="$X.$Y.$Z"
          echo "new=$NEW" >> $GITHUB_OUTPUT

          mvn versions:set -DnewVersion="$NEW"
          mvn versions:commit

      # --------------------------------------------------
      # Commit version bump
      # --------------------------------------------------
      - name: Commit version bump
        if: steps.bump.outputs.type != 'none'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          VERSION="${{ steps.bumpver.outputs.new }}"
          git add pom.xml
          git commit -m "chore(release): v$VERSION"
          git push origin master

      # --------------------------------------------------
      # Read Maven coordinates
      # --------------------------------------------------
      - name: Read Maven coordinates
        id: coords
        run: |
          echo "groupId=$(mvn help:evaluate -Dexpression=project.groupId -q -DforceStdout)" >> $GITHUB_OUTPUT
          echo "artifactId=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)" >> $GITHUB_OUTPUT

      # --------------------------------------------------
      # Build JAR (ONCE)
      # --------------------------------------------------
      - name: Build JAR
        if: steps.bump.outputs.type != 'none'
        run: mvn clean package -DskipTests

      # --------------------------------------------------
      # Maven settings
      # --------------------------------------------------
      - name: Configure Maven settings
        if: steps.bump.outputs.type != 'none'
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings xmlns="http://maven.apache.org/SETTINGS/1.2.0">
            <servers>
              <server>
                <id>scenemanager-releases</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # --------------------------------------------------
      # TRY: Full deploy (may partially upload!)
      # --------------------------------------------------
      - name: Deploy to Nexus (release)
        if: steps.bump.outputs.type != 'none'
        continue-on-error: true
        run: mvn deploy -DskipTests

      # --------------------------------------------------
      # Create Git tag (ALWAYS)
      # --------------------------------------------------
      - name: Create Git tag
        if: steps.bump.outputs.type != 'none'
        run: |
          VERSION="${{ steps.bumpver.outputs.new }}"
          git tag "v$VERSION" || true
          git push origin --tags

      # --------------------------------------------------
      # GitHub Release (ALWAYS has JAR)
      # --------------------------------------------------
      - name: Create GitHub Release
        if: steps.bump.outputs.type != 'none'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.bumpver.outputs.new }}
          name: Release v${{ steps.bumpver.outputs.new }}
          generate_release_notes: true
          files: |
            target/*.jar

      # --------------------------------------------------
      # Back to SNAPSHOT
      # --------------------------------------------------
      - name: Prepare next SNAPSHOT
        if: steps.bump.outputs.type != 'none'
        run: |
          mvn versions:set -DnewVersion="${{ steps.bumpver.outputs.new }}-SNAPSHOT"
          mvn versions:commit
          git add pom.xml
          git commit -m "chore: prepare next development iteration"
          git push origin master
